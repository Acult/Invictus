namespace = gadir_inv

gadir_inv.1 = { # Starting Event of the Tree
	type = country_event
	title = gadir_inv.1.t
	desc = gadir_inv.1.desc
	picture = interesting_histories_purple_soldier

	left_portrait = current_ruler
	right_portrait = c:CAR.current_ruler

	option = { # We can't accept it
		name = gadir_inv.1.a
		add_country_modifier = {
			name = gadir_modifier_2
			duration = 9125 #25 yrs
		}
		if = {
			limit = {
				c:CAR = {
					has_opinion = {
						target = root
						modifier = gadir_friendly_opinion_modifier
					}
				}
			}
			add_political_influence = -50
			custom_tooltip = gadir_inv.1.tt
		}
	}

	option = { # Maintain the Status Quo
		name = gadir_inv.1.b
		add_country_modifier = {
			name = gadir_modifier_3
			duration = 9125 #25 yrs
		}
		set_variable = { #skips all the tasks confronting with Carthage and disallows mission tree 2
			name = coward_not_facing_carthage_and_skipping_half_the_content
			days = -1
		}
		c:CAR = {
			add_opinion = {
				target = root
				modifier = trade_contact_well_treated
			}
		}
	}
}

gadir_inv.2 = { # The Gadiran Armada
	type = country_event
	title = gadir_inv.2.t
	desc = gadir_inv.2.desc
	picture = interesting_histories_ship_port_africa

	left_portrait = current_ruler
	right_portrait = scope:random_admiral

	immediate = {
		random_character = {
			limit = {
				is_admiral = yes
			}
			save_scope_as = random_admiral
		}
	}

	option = { # Focus on Offense
		name = gadir_inv.2.a
		add_country_modifier = {
			name = gadir_modifier_10
			duration = 9125 #25 yrs
		}
	}
	option = { # Focus on Defense
		name = gadir_inv.2.b
		add_country_modifier = {
			name = gadir_modifier_11
			duration = 9125 #25 yrs
		}
	}
	option = { # Focus on Maintenance
		name = gadir_inv.2.c
		add_country_modifier = {
			name = gadir_modifier_12
			duration = 9125 #25 yrs
		}
	}
}

gadir_inv.3 = { # Start of the war, create the tags. This event is triggered for Carthage
	type = country_event
	title = gadir_inv.3.t
	desc = gadir_inv.3.desc
	picture = interesting_histories_purple_soldier

	left_portrait = c:CAR.current_ruler
	right_portrait = scope:baetica_governor_scope
	right_portrait = scope:mauretania_governor_scope
	left_portrait = c:GAD.current_ruler

	trigger = {
		region:baetica_region = {
			any_region_province = {
				owner = c:CAR
			}
		}
	}

	immediate = {
		p:1278.governor = {
			save_scope_as = baetica_governor_scope
		}
		p:3061.governor = {
			save_scope_as = mauretania_governor_scope
		}

		p:1348 = {
			create_country = {
				name = {
					name = BAETICA_REBELS
					adjective = BAETICA_REBELS_ADJECTIVE
				}
				set_primary_culture = carthaginian
				set_country_religion = carthaginian_pantheon
				change_government = aristocratic_republic
				set_country_heritage = punic_heritage
				save_scope_as = baetica_rebels_country_scope
				change_country_tag = BRR
				set_as_ruler = scope:baetica_governor_scope
			}
		}

		region:baetica_region = {
			every_region_province = {
				limit = {
					owned_or_subject_owned = c:CAR 
				}
				set_owned_by = scope:baetica_rebels_country_scope
			}
		}

		if = {
			limit = {
				scope:mauretania_governor_scope = {
					is_friend = c:GAD.current_ruler
				}
			}
			ordered_owned_province = {
				limit = {
					is_in_region = mauretania_region
				}
				order_by = total_population
				create_country = {
					name = {
						name = MAURETANIA_REBELS
						adjective = MAURETANIA_REBELS_ADJECTIVE
					}
					set_primary_culture = carthaginian
					set_country_religion = carthaginian_pantheon
					change_government = aristocratic_republic
					set_country_heritage = punic_heritage
					save_scope_as = mauretania_rebels_country_scope
					change_country_tag = MRR
					set_as_ruler = scope:mauretania_governor_scope
				}
			}

			region:mauretania_region = {
				every_region_province = {
					limit = {
						owned_or_subject_owned = c:CAR 
						is_in_area = mauretania_tingitana_meridionalis_area
						is_in_area = mauretania_tingitana_septentrionalis_area
						is_in_area = rutubis_area
					}
					set_owned_by = scope:mauretania_rebels_country_scope
				}
			}
		}

		c:GAD = {
			declare_war_with_wargoal = {
				war_goal = naval_wargoal
				target = c:CAR
			}
		}
		random_current_war = {
			limit = {
				any_war_attacker = { this = c:GAD }
				any_war_defender = { this = c:CAR }
			}
			save_scope_as = gadir_carthage_war_scope
		}
		scope:baetica_rebels_country_scope = {
			add_to_war = {
				target = scope:gadir_carthage_war_scope
				attacker = yes
				leader = no
			}
		}
		if = {
			limit = {
				c:MRR = {
					exists = yes
					has_land = yes
				}
			}
			scope:mauretania_rebels_country_scope = {
				add_to_war = {
					target = scope:gadir_carthage_war_scope
					attacker = yes
					leader = no
				}
			}
		}
	}

	option = {
		name = gadir_inv.3.a
		c:GAD = {
			trigger_event = { # Tell the player that they are at war
				id = gadir_inv.4
				days = -1
			}
		}
	}
}

gadir_inv.4 = { # Tell the player that they are at war
	type = country_event
	title = gadir_inv.4.t
	desc = gadir_inv.4.desc
	picture = council_country

	goto_location = c:CAR.capital_scope
	
	left_portrait = current_ruler
	left_portrait = c:BRR.current_ruler
	left_portrait = c:MRR.current_ruler
	right_portrait = c:CAR.current_ruler

	option = {
		name = gadir_inv.4.a
	}
}

gadir_inv.5 = { # Annexation of the rebel governarates by Gadir
	type = country_event
	title = gadir_inv.5.t
	desc = gadir_inv.5.desc
	picture = interesting_histories_punic_town

	immediate = {
		c:BRR = {
			every_owned_province = {
				set_owned_by = c:GAD
			}
		}

		if = {
			limit = {
				c:MRR = {
					has_land = yes
				}
			}
			c:MRR = {
				every_owned_province = {
					set_owned_by = c:GAD
				}
			}
		}
	}

	option = {
		name = gadir_inv.5.a
	}
}

gadir_inv.6 = { # Start of small event chain for task 1
	type = country_event
	title = gadir_inv.6.t
	desc = gadir_inv.6.desc
	picture = interesting_histories_ship_port_africa
	left_portrait = current_ruler
	right_portrait = c:CAR.current_ruler

	option = { #claims; claim the land and ignore Carthage's offers
		name = gadir_inv.6.a
		region:baetica_region = {
			every_region_province = {
				limit = {
					owner = c:CAR
				}
				add_claim = c:GAD
			}
		}
	}

	option = { #opinion; made deal with Carthage
		name = gadir_inv.6.b
		reverse_add_opinion = {
			modifier = gadir_friendly_opinion_modifier
			target = c:CAR
		}
		add_political_influence = 25
		add_gold = 100
	}

	after = {
		trigger_event = {
			id = gadir_inv.7
			days = { 10 20 }
		}
	}
}

gadir_inv.7 = {
	type = country_event
	title = gadir_inv.7.t
	desc = gadir_inv.7.desc
	picture = interesting_histories_ship_port_africa
	left_portrait = current_ruler
	right_portrait = c:CAR.current_ruler

	option = { #claims; claim the land and ignore Carthage's offers
		name = gadir_inv.6.a
		area:mauretania_tingitana_septentrionalis_area = {
			every_area_province = {
				limit = {
					owner = c:CAR
				}
				add_claim = c:GAD
			}
		}
		area:mauretania_tingitana_meridionalis_area = {
			every_area_province = {
				limit = {
					owner = c:CAR
				}
				add_claim = c:GAD
			}
		}
		area:rutubis_area = {
			every_area_province = {
				limit = {
					owner = c:CAR
				}
				add_claim = c:GAD
			}
		}
	}

	option = { #opinion; made deal with Carthage
		name = gadir_inv.6.b
		reverse_add_opinion = {
			modifier = gadir_friendly_opinion_modifier
			target = c:CAR
		}
		add_political_influence = 25
		add_gold = 100
	}
}

gadir_inv.8 = {	# Initial event - pick a target
	type = country_event
	title = gadir_inv.8.t
	desc = gadir_inv.8.desc
	picture = dagger_behind_back
	left_portrait = scope:kill_them_all_1
	left_portrait = scope:kill_them_all_2
	right_portrait = scope:kill_them_all_3
	right_portrait = scope:kill_them_all_4

	immediate = {
		c:CAR = {
			random_character = {	# Ruler
				limit = {
					is_ruler = yes
				}
				save_scope_as = kill_them_all_1
			}
			random_character = {	# Some governor
				limit = {
					is_ruler = no
					is_governor = yes
				}
				save_scope_as = kill_them_all_2
			}
			random_character = {	# General
				limit = {
					is_ruler = no
					is_general = yes
					is_governor = no
				}
				save_scope_as = kill_them_all_3
			}
			random_character = {	# Researcher
				limit = {
					has_job = yes
					has_any_office = no
					is_general = no
					is_admiral = no
					is_governor = no
					is_ruler = no
				}
				save_scope_as = kill_them_all_4
			}
		}
	}

	option = {	# Choose the RULER
		trigger = {
			scope:kill_them_all_1 = {
				exists = yes
			}
		}
		name = gadir_inv.8.a
		custom_tooltip = gadir_inv.8.tt
		custom_tooltip = gadir_inv.8.at
		scope:kill_them_all_1 = {
			save_scope_as = selected_to_kill_char
		}
	}

	option = {	# Choose the GOVERNOR
		trigger = {
			scope:kill_them_all_2 = {
				exists = yes
			}
		}
		name = gadir_inv.8.b
		custom_tooltip = gadir_inv.8.tt
		scope:kill_them_all_2 = {
			save_scope_as = selected_to_kill_char
		}
	}

	option = {	# Choose the GENERAL
		trigger = {
			scope:kill_them_all_3 = {
				exists = yes
			}
		}
		name = gadir_inv.8.c
		custom_tooltip = gadir_inv.8.tt
		scope:kill_them_all_3 = {
			save_scope_as = selected_to_kill_char
		}
	}

	option = {	# Choose the RESEARCHER
		trigger = {
			scope:kill_them_all_4 = {
				exists = yes
			}
		}
		name = gadir_inv.8.d
		custom_tooltip = gadir_inv.8.tt
		scope:kill_them_all_4 = {
			save_scope_as = selected_to_kill_char
		}
	}

	after = {
		trigger_event = {
			id = gadir_inv.9
			days = 30
		}
	}
}

gadir_inv.9 = {	# Choose your assassin
	type = country_event
	title = gadir_inv.9.t
	desc = gadir_inv.9.desc
	picture = dagger_behind_back
	left_portrait = current_ruler
	right_portrait = scope:would_be_assassin_1
	right_portrait = scope:would_be_assassin_2
	right_portrait = scope:would_be_assassin_3

	immediate = {
		random_character = {
			limit = {
				is_adult = yes
				highest_skill = finesse
				loyalty >= 40
			}
			save_scope_as = would_be_assassin_1
		}
		random_character = {
			limit = {
				is_adult = yes
				highest_skill = finesse
				loyalty >= 40
				age != scope:would_be_assassin_1.age
			}
			save_scope_as = would_be_assassin_2
		}
		random_character = {
			limit = {
				is_adult = yes
				highest_skill = finesse
				loyalty >= 40
				age != scope:would_be_assassin_1.age
				age != scope:would_be_assassin_2.age
			}
			save_scope_as = would_be_assassin_3
		}
	}

	option = {
		trigger = {
			scope:would_be_assassin_1 = {
				exists = yes
			}
		}
		name = gadir_inv.9.a
		add_treasury = -100
		scope:would_be_assassin_1 = {
			add_gold = 100
			save_scope_as = selected_assassin_char
		}
		custom_tooltip = gadir_inv.9.tt
		hidden_effect = {
			scope:would_be_assassin_1 = {
				move_country = c:CAR
				remove_character_modifier = foreign_citizen	# To prevent being made a citizen
				add_character_modifier = {
					name = visiting_foreign_citizen
					duration = -1
				}
			}
		}
	}

	option = {
		trigger = {
			scope:would_be_assassin_2 = {
				exists = yes
			}
		}
		name = gadir_inv.9.b
		add_treasury = -100
		scope:would_be_assassin_2 = {
			add_gold = 100
			save_scope_as = selected_assassin_char
		}
		custom_tooltip = gadir_inv.9.tt
		hidden_effect = {
			scope:would_be_assassin_2 = {
				move_country = c:CAR
				remove_character_modifier = foreign_citizen	# To prevent being made a citizen
				add_character_modifier = {
					name = visiting_foreign_citizen
					duration = -1
				}
			}
		}
	}

	option = {
		trigger = {
			scope:would_be_assassin_3 = {
				exists = yes
			}
		}
		name = gadir_inv.9.c
		add_treasury = -100
		scope:would_be_assassin_3 = {
			add_gold = 100
			save_scope_as = selected_assassin_char
		}
		custom_tooltip = gadir_inv.9.tt
		hidden_effect = {
			scope:would_be_assassin_3 = {
				move_country = c:CAR
				remove_character_modifier = foreign_citizen	# To prevent being made a citizen
				add_character_modifier = {
					name = visiting_foreign_citizen
					duration = -1
				}
			}
		}
	}

	after = {
		trigger_event = {
			id = gadir_inv.10
			days = 30
		}
	}
}

gadir_inv.10 = {	# Assassination or kidnapping?
	type = country_event
	title = gadir_inv.10.t
	desc = gadir_inv.10.desc
	picture = dagger_behind_back
	left_portrait = scope:selected_assassin_char
	right_portrait = scope:selected_to_kill_char

	option = {	# Assassination
		name = gadir_inv.10.a
		custom_tooltip = gadir_inv.10.at
		set_variable = {
			name = will_assassinate
		}
	}

	option = {	# Kidnapping
		trigger = {
			scope:selected_to_kill_char = {
				is_ruler = no
			}
		}
		name = gadir_inv.10.b
		custom_tooltip = gadir_inv.10.bt
		set_variable = {
			name = will_kidnap
		}
	}

	after = {
		trigger_event = {
			id = gadir_inv.11
			days = 30
		}
	}
}

gadir_inv.11 = {	# Result of the attempt
	type = country_event
	title = gadir_inv.11.t
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					has_variable = will_assassinate
				}
				desc = gadir_inv.11.desc_1
			}
			triggered_desc = {
				trigger = {
					has_variable = will_kidnap
				}
				desc = gadir_inv.11.desc_2
			}
		}
		first_valid = {
			triggered_desc = {
				trigger = {
					has_variable = assassination_success
				}
				desc = gadir_inv.11.desc_1_1
			}
			triggered_desc = {
				trigger = {
					has_variable = assassination_failure
				}
				desc = gadir_inv.11.desc_1_2
			}
			triggered_desc = {
				trigger = {
					has_variable = kidnapping_success
				}
				desc = gadir_inv.11.desc_2_1
			}
			triggered_desc = {
				trigger = {
					has_variable = kidnapping_failure
				}
				desc = gadir_inv.11.desc_2_2
			}
		}
		first_valid = {
			triggered_desc = {
				trigger = {
					has_variable = operative_got_away
				}
				desc = gadir_inv.11.desc_3
			}
			triggered_desc = {
				trigger = {
					NOT = {
						has_variable = operative_got_away
					}
				}
				desc = gadir_inv.11.desc_4
			}
		}
	}
	picture = assassination
	left_portrait = scope:selected_assassin_char
	right_portrait = scope:selected_to_kill_char

	immediate = {
		random_list = {
			2 = {	# Success
				modifier = {
					factor = 2
					has_variable = will_assassinate
				}
				modifier = {
					factor = 2
					scope:selected_assassin_char = {
						finesse >= 8
					}
				}
				modifier = {
					factor = 3
					scope:selected_assassin_char = {
						OR = {
							has_trait = crafty
							has_trait = cautious
							has_trait = shrewd
						}
					}
				}
				modifier = {
					factor = 2
					scope:selected_to_kill_char = {
						OR = {
							has_trait = submissive
							has_trait = reckless
							has_trait = trusting
						}
					}
				}
				modifier = {
					factor = 2
					scope:selected_to_kill_char = {
						finesse < 5
					}
				}
				modifier = {	# Heavily decreased chances if ruler
					factor = 0.2
					scope:selected_to_kill_char = {
						is_ruler = yes
					}
				}
				if = {
					limit = {
						has_variable = will_assassinate
					}
					set_variable = {
						name = assassination_success
					}
					scope:selected_to_kill_char = {
						death = {
							killer = scope:selected_assassin_char
							death_reason = death_assassinated
						}
					}
				}
				else_if = {
					limit = {
						has_variable = will_kidnap
					}
					set_variable = {
						name = kidnapping_success
					}
					scope:selected_to_kill_char = {
						if = {
							limit = {
								is_governor = yes
							}
							remove_as_governor = yes
						}
						if = {
							limit = {
								is_general = yes
							}
							remove_command = yes
						}
						move_country_with_message = c:GAD
						add_loyalty = kidnapped_loyalty
						force_add_trait = vengeful
					}
					imprison = {
						target = scope:selected_to_kill_char
					}
				}
				set_variable = {
					name = operative_got_away
				}
				scope:selected_assassin_char = {
					add_finesse = 1
					add_zeal = 1
					force_add_trait = deceitful
					move_country_with_message = root
					hidden_effect = {
						set_home_country = root
						remove_character_modifier = visiting_foreign_citizen
						remove_character_modifier = foreign_citizen
					}
				}
			}
			2 = {	# Failure
				modifier = {
					factor = 2
					has_variable = will_kidnap
				}
				modifier = {
					factor = 2
					scope:selected_assassin_char = {
						finesse >= 5
					}
				}
				modifier = {
					factor = 3
					scope:selected_assassin_char = {
						OR = {
							has_trait = guileless
							has_trait = reckless
							has_trait = foolish
						}
					}
				}
				modifier = {
					factor = 2
					scope:selected_to_kill_char = {
						OR = {
							has_trait = assertive
							has_trait = cautious
							has_trait = suspicious
						}
					}
				}
				modifier = {
					factor = 2
					scope:selected_to_kill_char = {
						finesse >= 8
					}
				}
				if = {
					limit = {
						has_variable = will_assassinate
					}
					set_variable = {
						name = assassination_failure
					}
				}
				else_if = {
					limit = {
						has_variable = will_kidnap
					}
					set_variable = {
						name = kidnapping_failure
					}
				}
				set_variable = {
					name = operative_got_away
				}
				scope:selected_to_kill_char = {
					force_add_trait = suspicious
				}
				scope:selected_assassin_char = {
					add_finesse = 1
					force_add_trait = sceptical
					move_country_with_message = root
					hidden_effect = {
						set_home_country = root
						remove_character_modifier = visiting_foreign_citizen
						remove_character_modifier = foreign_citizen
					}
				}
			}
			1 = {	# Critical failure
				modifier = {
					factor = 2
					has_variable = will_kidnap
				}
				modifier = {
					factor = 4
					scope:selected_assassin_char = {
						finesse < 5
					}
				}
				modifier = {
					factor = 2
					scope:selected_assassin_char = {
						OR = {
							has_trait = guileless
							has_trait = reckless
							has_trait = foolish
						}
					}
				}
				modifier = {
					factor = 2
					scope:selected_to_kill_char = {
						OR = {
							has_trait = assertive
							has_trait = cautious
							has_trait = suspicious
						}
					}
				}
				modifier = {
					factor = 2
					scope:selected_to_kill_char = {
						finesse >= 8
					}
				}
				scope:selected_to_kill_char = {
					force_add_trait = suspicious
				}
				scope:selected_assassin_char = {
					death = {
						killer = scope:selected_assassin_char
						death_reason = death_escaping
					}
				}
			}
		}
		c:CAR = {
			trigger_event = {
				id = gadir_inv.12
			}
		}
	}

	option = {	# Success
		trigger = {
			OR = {
				has_variable = assassination_success
				has_variable = kidnapping_success
			}
		}
		name = gadir_inv.11.a
		exclusive = yes
		if = {
			limit = {
				has_variable = kidnapping_success
			}
			add_treasury = scope:selected_to_kill_char.wealth
			scope:selected_to_kill_char = {
				add_gold = {
					value = wealth
					multiply = -1
				}
			}
		}
	}

	option = {	# Failure
		trigger = {
			OR = {
				has_variable = assassination_failure
				has_variable = kidnapping_failure
			}
		}
		name = gadir_inv.11.b
		exclusive = yes
	}

	option = {	# Critical failure
		name = gadir_inv.11.c
	}

	after = {
		remove_variable = will_assassinate
		remove_variable = will_kidnap
		remove_variable = assassination_success
		remove_variable = assassination_failure
		remove_variable = kidnapping_success
		remove_variable = kidnapping_failure
		remove_variable = operative_got_away
	}
}

gadir_inv.12 = {	# Overlord - notification of the attempt
	type = country_event
	title = gadir_inv.12.t
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					c:GAD = {
						has_variable = assassination_success
					}
				}
				desc = gadir_inv.12.desc_1_1
			}
			triggered_desc = {
				trigger = {
					c:GAD = {
						has_variable = kidnapping_success
					}
				}
				desc = gadir_inv.12.desc_2_1
			}
			triggered_desc = {
				trigger = {
					c:GAD = {
						has_variable = assassination_failure
					}
				}
				desc = gadir_inv.12.desc_1_2
			}
			triggered_desc = {
				trigger = {
					c:GAD = {
						has_variable = kidnapping_failure
					}
				}
				desc = gadir_inv.12.desc_2_2
			}
		}
		first_valid = {
			triggered_desc = {
				trigger = {
					c:GAD = {
						has_variable = operative_got_away
					}
				}
				desc = gadir_inv.12.desc_3
			}
			triggered_desc = {
				trigger = {
					c:GAD = {
						NOT = {
							has_variable = operative_got_away
						}
					}
				}
				desc = gadir_inv.12.desc_4
			}
		}
	}
	picture = assassination
	left_portrait = current_ruler
	right_portrait = scope:selected_assassin_char

	immediate = {
		if = {
			limit = {
				c:GAD = {
					has_variable = assassination_success
				}
			}
			custom_tooltip = gadir_inv.12.tt_1
		}
		else_if = {
			limit = {
				c:GAD = {
					has_variable = kidnapping_success
				}
			}
			custom_tooltip = gadir_inv.12.tt_2
		}
	}

	option = {
		name = gadir_inv.12.a
	}

}

gadir_inv.13 = { #flavour event task 5
	title = gadir_inv.13.t
	desc = gadir_inv.13.desc
	picture = interesting_histories_punic_town
	left_portrait = current_ruler

	trigger = {
		tag = GAD
		has_variable = tharsis_trade_hub_enable
		NOT = {
			has_variable = tharsis_trade_hub
		}
	}

	option = {
		name = gadir_inv.13.a
	}

	option = {
		name = gadir_inv.13.b
		exclusive = yes
		trigger = {
			current_date >= 480.1.1
			p:1415 = {
				total_population >= 30
				trade_good_surplus = {
					target = iron
					value >= 4
				}
			}
		}
		p:1415 = { #upgrade Tharsis + modifier
			increase_province_rank_effect = yes
			add_province_modifier = {
				name = gadir_modifier_17
				duration = -1
			}
		}
		set_variable = tharsis_trade_hub
		custom_tooltip = gadir_inv.13.tt
	}
}